<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PvP Double or Nothing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Adăugat GoogleAuthProvider, signInWithPopup, signOut
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, limit, orderBy, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // CONFIGURARE FIREBASE
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDSQD3YDBkwdrkUyw6xNEvYdLhbWPdEiKo",
            authDomain: "coinflip-172f5.firebaseapp.com",
            projectId: "coinflip-172f5",
            storageBucket: "coinflip-172f5.firebasestorage.app",
            messagingSenderId: "564936884544",
            appId: "1:564936884544:web:6dc81d08e9b1c5b67c7aa5",
            measurementId: "G-03GWNJGV4M"
        };

        // Integrare mediu de dezvoltare (AI Preview)
        if ((!firebaseConfig.apiKey || firebaseConfig.apiKey === "") && typeof __firebase_config !== 'undefined') {
             try { Object.assign(firebaseConfig, JSON.parse(__firebase_config)); } catch(e){}
        }

        if (!firebaseConfig.apiKey) {
            document.body.innerHTML = '<div class="text-red-500 p-10">Lipsește configurația Firebase.</div>';
            throw new Error("Configurare lipsă.");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- Stare Globală ---
        let currentUser = null;
        let currentRoomId = null;
        let userData = null; // Păstrăm datele utilizatorului local pentru timer
        let roomUnsubscribe = null;
        let userUnsubscribe = null;
        let myActiveRoomsUnsubscribe = null;
        let bonusInterval = null;

        // --- Constante ---
        const COLLECTION_USERS = `coinflip_users`;
        const COLLECTION_ROOMS = `coinflip_rooms`; 
        const BONUS_AMOUNT = 100;
        const BONUS_COOLDOWN = 24 * 60 * 60 * 1000; // 24 ore în milisecunde

        // --- Elemente DOM ---
        const views = {
            login: document.getElementById('view-login'),
            lobby: document.getElementById('view-lobby'),
            game: document.getElementById('view-game'),
            leaderboard: document.getElementById('view-leaderboard')
        };

        const ui = {
            balance: document.querySelectorAll('.ui-balance'),
            username: document.querySelectorAll('.ui-username'),
            avatar: document.querySelectorAll('.ui-avatar'),
            status: document.getElementById('game-status'),
            coin: document.getElementById('coin'),
            waitingControls: document.getElementById('waiting-controls'),
            activeControls: document.getElementById('active-controls'),
            activeGamesList: document.getElementById('active-games-list'),
            leaderboardList: document.getElementById('leaderboard-list'),
            bonusCard: document.getElementById('bonus-card'),
            bonusBtn: document.getElementById('btn-claim-bonus'),
            bonusTimer: document.getElementById('bonus-timer')
        };

        // --- Funcții Autentificare ---

        // 1. Google Login
        window.loginGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // AuthStateChanged va prelua controlul
            } catch (error) {
                console.error(error);
                alert("Eroare la conectare: " + error.message);
            }
        };

        // 2. Guest Login
        window.loginGuest = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error(error);
                alert("Eroare Guest: " + error.message);
            }
        };

        // 3. Logout
        window.performLogout = async () => {
            if(confirm("Ești sigur că vrei să te deconectezi?")) {
                await signOut(auth);
                window.location.reload();
            }
        };

        // Listener Autentificare
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Dacă suntem în AI Preview cu token custom
                if (typeof __initial_auth_token !== 'undefined' && !user.isAnonymous) {
                     // Logica deja existentă se ocupă de token
                }
                
                await ensureUserProfile();
                setupUserListener();
                setupActiveGamesListener();
                
                // Ascundem login, arătăm lobby
                switchView('lobby');
            } else {
                // Dacă nu e logat, arătăm ecranul de login
                switchView('login');
            }
        });

        async function ensureUserProfile() {
            try {
                const userRef = doc(db, COLLECTION_USERS, currentUser.uid);
                const snap = await getDoc(userRef);
                
                if (!snap.exists()) {
                    // Utilizator nou
                    await setDoc(userRef, {
                        username: currentUser.displayName || `Jucător ${currentUser.uid.slice(0, 4)}`,
                        photoURL: currentUser.photoURL || null,
                        balance: 1000, // Bonus de început
                        wins: 0,
                        lastBonusClaim: 0, // Nu a revendicat niciodată
                        createdAt: Date.now()
                    });
                } else {
                    // Actualizăm poza/numele dacă s-a logat cu Google peste un cont existent (opțional)
                    if (currentUser.photoURL && !snap.data().photoURL) {
                        await updateDoc(userRef, { photoURL: currentUser.photoURL });
                    }
                }
            } catch (e) {
                console.error("Profile Error:", e);
                if (e.code === 'permission-denied') {
                    alert("Eroare Permisiuni: Verifică regulile Firestore.");
                }
            }
        }

        // --- Logică Bonus Zilnic ---
        
        function updateBonusUI() {
            if (!userData) return;
            
            const now = Date.now();
            const lastClaim = userData.lastBonusClaim || 0;
            const diff = now - lastClaim;

            if (diff >= BONUS_COOLDOWN) {
                // Bonus Disponibil
                ui.bonusBtn.disabled = false;
                ui.bonusBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                ui.bonusBtn.classList.add('animate-pulse');
                ui.bonusBtn.innerHTML = '<i class="fa-solid fa-gift mr-2"></i>REVENDICĂ 100p';
                ui.bonusTimer.innerText = "Bonusul este disponibil acum!";
                ui.bonusTimer.classList.add('text-green-400');
                if(bonusInterval) clearInterval(bonusInterval);
            } else {
                // Bonus Indisponibil - Arată Timer
                ui.bonusBtn.disabled = true;
                ui.bonusBtn.classList.add('opacity-50', 'cursor-not-allowed');
                ui.bonusBtn.classList.remove('animate-pulse');
                ui.bonusBtn.innerHTML = '<i class="fa-solid fa-clock mr-2"></i>AȘTEAPTĂ';
                ui.bonusTimer.classList.remove('text-green-400');
                
                const timeLeft = BONUS_COOLDOWN - diff;
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                ui.bonusTimer.innerText = `Următorul bonus în: ${hours}h ${minutes}m ${seconds}s`;
            }
        }

        window.claimDailyBonus = async () => {
            if (!userData) return;
            
            const now = Date.now();
            const lastClaim = userData.lastBonusClaim || 0;
            
            if (now - lastClaim >= BONUS_COOLDOWN) {
                ui.bonusBtn.disabled = true; // Previne dublu click
                
                try {
                    await updateDoc(doc(db, COLLECTION_USERS, currentUser.uid), {
                        balance: increment(BONUS_AMOUNT),
                        lastBonusClaim: now
                    });
                    
                    // Efect vizual (confetti sau simplu alert)
                    alert(`Ai primit ${BONUS_AMOUNT} puncte bonus zilnic!`);
                    
                } catch (e) {
                    console.error("Eroare Bonus:", e);
                    alert("Nu s-a putut revendica bonusul.");
                }
            }
        };

        function setupUserListener() {
            if (userUnsubscribe) userUnsubscribe();
            userUnsubscribe = onSnapshot(doc(db, COLLECTION_USERS, currentUser.uid), (doc) => {
                if (doc.exists()) {
                    userData = doc.data();
                    
                    // Actualizare UI Bază
                    ui.balance.forEach(el => el.innerText = userData.balance);
                    ui.username.forEach(el => el.innerText = userData.username);
                    
                    // Actualizare Avatar
                    ui.avatar.forEach(img => {
                        if (userData.photoURL) {
                            img.src = userData.photoURL;
                        } else {
                            // Avatar default (roboțel bazat pe ID)
                            img.src = `https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${currentUser.uid}`;
                        }
                    });

                    // Pornire Timer Bonus
                    updateBonusUI();
                    if (bonusInterval) clearInterval(bonusInterval);
                    bonusInterval = setInterval(updateBonusUI, 1000);
                }
            });
        }

        // --- Rejoin / Active Games Logic ---
        function setupActiveGamesListener() {
            if (myActiveRoomsUnsubscribe) myActiveRoomsUnsubscribe();
            const q = query(
                collection(db, COLLECTION_ROOMS), 
                where('hostId', '==', currentUser.uid),
                where('status', 'in', ['waiting', 'playing'])
            );

            myActiveRoomsUnsubscribe = onSnapshot(q, (snapshot) => {
                const list = ui.activeGamesList;
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-gray-500 text-sm italic">Niciun pariu activ.</div>';
                    return;
                }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isWaiting = data.status === 'waiting';
                    const badgeColor = isWaiting ? 'bg-yellow-600' : 'bg-green-600';
                    const badgeText = isWaiting ? 'AȘTEPTARE' : 'ÎN JOC';
                    const el = document.createElement('div');
                    el.className = 'bg-gray-800 border border-gray-700 p-3 rounded flex justify-between items-center mb-2';
                    el.innerHTML = `
                        <div>
                            <span class="text-xs font-bold px-2 py-1 rounded ${badgeColor} text-white mr-2">${badgeText}</span>
                            <span class="font-bold text-white">${data.betSize}p</span>
                            ${data.joinCode ? `<span class="ml-2 text-xs text-blue-400"><i class="fa-solid fa-key"></i> ${data.joinCode}</span>` : ''}
                        </div>
                        <button onclick="rejoinRoom('${doc.id}')" class="text-sm bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-white">
                            ${isWaiting ? 'Gestionează' : 'Reintră'}
                        </button>
                    `;
                    list.appendChild(el);
                });
            });
        }

        window.rejoinRoom = (roomId) => {
            currentRoomId = roomId;
            switchView('game');
            subscribeToRoom(roomId);
        };

        // --- Navigare ---
        window.switchView = (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            if(views[viewName]) views[viewName].classList.remove('hidden');
            if (viewName === 'leaderboard') loadLeaderboard();
        };

        // --- Lobby Logic ---
        window.findMatch = async (betSize) => { await joinMatch(betSize, null); };

        window.createPrivateRoom = async () => {
             const betSize = parseInt(document.getElementById('custom-bet-size').value);
             const code = document.getElementById('custom-room-code').value.trim();
             if (!betSize || betSize <= 0) return alert("Sumă invalidă.");
             await joinMatch(betSize, true, code || null);
        };

        window.joinByCode = async () => {
            const code = document.getElementById('join-room-code').value.trim();
            if (!code) return alert("Introdu un cod.");
            ui.status.innerHTML = '<span class="animate-pulse">Caut camera...</span>';
            const q = query(
                collection(db, COLLECTION_ROOMS), 
                where('joinCode', '==', code),
                where('status', '==', 'waiting'),
                limit(1)
            );
            const snapshot = await getDocs(q);
            if (snapshot.empty) { alert("Camera nu există sau a început deja."); return; }
            const roomDoc = snapshot.docs[0];
            const roomData = roomDoc.data();
            if (roomData.hostId === currentUser.uid) rejoinRoom(roomDoc.id);
            else await enterRoom(roomDoc.id, roomData.betSize);
        };

        async function joinMatch(betSize, forceCreate, joinCode = null) {
            if (userData.balance < betSize) { alert("Fonduri insuficiente!"); return; }
            switchView('game');
            resetGameUI();
            ui.status.innerHTML = '<span class="animate-pulse">Se caută...</span>';

            if (forceCreate) { await createRoom(betSize, joinCode); return; }

            const q = query(
                collection(db, COLLECTION_ROOMS), 
                where('status', '==', 'waiting'), 
                where('betSize', '==', betSize),
                where('joinCode', '==', null), 
                limit(10)
            );
            let snapshot = await getDocs(q);
            const validRoom = snapshot.docs.find(d => d.data().hostId !== currentUser.uid);
            if (validRoom) await enterRoom(validRoom.id, betSize);
            else await createRoom(betSize, null);
        }

        async function createRoom(betSize, joinCode) {
            await updateDoc(doc(db, COLLECTION_USERS, currentUser.uid), { balance: increment(-betSize) });
            const roomRef = doc(collection(db, COLLECTION_ROOMS));
            currentRoomId = roomRef.id;
            await setDoc(roomRef, {
                hostId: currentUser.uid,
                guestId: null,
                betSize: betSize,
                currentPot: betSize,
                status: 'waiting',
                turn: 'host',
                createdAt: Date.now(),
                lastFlip: null,
                actionRequired: null,
                joinCode: joinCode
            });
            subscribeToRoom(currentRoomId);
        }

        async function enterRoom(roomId, betSize) {
            await updateDoc(doc(db, COLLECTION_USERS, currentUser.uid), { balance: increment(-betSize) });
            const roomRef = doc(db, COLLECTION_ROOMS, roomId);
            await updateDoc(roomRef, {
                guestId: currentUser.uid,
                status: 'playing',
                currentPot: increment(betSize)
            });
            currentRoomId = roomId;
            subscribeToRoom(roomId);
        }

        // --- Game Logic ---
        function subscribeToRoom(roomId) {
            if (roomUnsubscribe) roomUnsubscribe();
            roomUnsubscribe = onSnapshot(doc(db, COLLECTION_ROOMS, roomId), async (snapshot) => {
                if (!snapshot.exists()) {
                    if (!document.getElementById('view-game').classList.contains('hidden')) {
                        alert("Camera a fost ștearsă.");
                        switchView('lobby');
                    }
                    return;
                }
                const data = snapshot.data();
                if (data.status === 'finished') {
                    const isInGameView = !document.getElementById('view-game').classList.contains('hidden');
                    if (isInGameView) {
                        if (data.endReason === 'folded' && data.winnerId === currentUser.uid) {
                            alert(`Adversarul a renunțat! Ai câștigat ${data.currentPot}p.`);
                            switchView('lobby'); return;
                        }
                        if (data.endReason === 'left' && data.winnerId === currentUser.uid) {
                            alert(`Adversarul a ieșit. Ai câștigat ${data.currentPot}p.`);
                            switchView('lobby'); return;
                        }
                        if (data.endReason === 'cashout' && data.winnerId !== currentUser.uid) {
                            alert(`Adversarul a încasat! A luat ${data.currentPot}p.`);
                            switchView('lobby'); return;
                        }
                    }
                }
                renderGameState(data);
            }, (error) => console.error("Sync error", error));
        }

        function renderGameState(data) {
            ui.potDisplay.innerText = data.currentPot;
            if (data.status === 'finished') {
                const isWinner = data.winnerId === currentUser.uid;
                const resultText = isWinner ? 'AI CÂȘTIGAT' : 'AI PIERDUT';
                const colorClass = isWinner ? 'text-green-500' : 'text-red-500';
                ui.status.innerHTML = `<span class="${colorClass} font-bold text-2xl">${resultText}</span><br><span class="text-sm text-gray-400">Motiv: ${data.endReason}</span>`;
                document.getElementById('my-actions').innerHTML = `<button onclick="switchView('lobby')" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg border-b-4 border-gray-900 mt-4">ÎNAPOI ÎN LOBBY</button>`;
                ui.waitingControls.classList.add('hidden');
                ui.activeControls.classList.add('hidden');
                return;
            }

            const amIHost = data.hostId === currentUser.uid;
            if (data.status === 'waiting' && data.joinCode) {
                ui.status.innerHTML = `Cod Cameră: <span class="text-yellow-400 font-mono text-2xl tracking-widest">${data.joinCode}</span>`;
            } else if (data.status === 'waiting') {
                ui.status.innerText = "Așteptare adversar...";
            }

            const opponentId = amIHost ? data.guestId : data.hostId;
            if (opponentId) {
                ui.opponentName.innerText = "Adversar Conectat"; 
                ui.opponentStatus.innerText = "Pregătit";
                ui.waitingControls.classList.add('hidden');
                ui.activeControls.classList.remove('hidden');
            } else {
                ui.opponentName.innerText = "Așteptare...";
                ui.opponentStatus.innerText = "";
                ui.activeControls.classList.add('hidden');
                if (amIHost && data.status === 'waiting') ui.waitingControls.classList.remove('hidden');
            }

            const myActions = document.getElementById('my-actions');
            myActions.innerHTML = '';

            if (data.status === 'playing') {
                if (data.lastFlip && data.lastFlip.timestamp > (window.lastProcessedFlip || 0)) {
                    window.lastProcessedFlip = data.lastFlip.timestamp;
                    animateFlip(data.lastFlip.result);
                    setTimeout(() => {
                         const winnerId = data.lastFlip.result === 'heads' ? data.hostId : data.guestId;
                         if (winnerId === currentUser.uid) {
                             ui.status.innerHTML = `<span class="text-green-400 font-bold">AI CÂȘTIGAT!</span>`;
                             showWinnerControls(data);
                         } else {
                             ui.status.innerHTML = `<span class="text-red-400 font-bold">AI PIERDUT!</span> Așteaptă...`;
                         }
                    }, 2000);
                    return;
                }

                if (!data.lastFlip) {
                    ui.status.innerText = "Start Joc! Gazda dă cu banul...";
                    if (amIHost) myActions.innerHTML = `<button onclick="performFlip()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-lg shadow-lg">DĂ CU BANUL</button>`;
                }
                
                if (data.actionRequired === 'accept_double') {
                     const lastWinner = data.lastFlip.result === 'heads' ? data.hostId : data.guestId;
                     if (lastWinner !== currentUser.uid) {
                         ui.status.innerHTML = `<span class="text-yellow-400">PROVOCARE!</span> Egalezi ${data.betSize}p?`;
                         myActions.innerHTML = `<div class="grid grid-cols-2 gap-2"><button onclick="respondToDouble(true)" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">ACCEPT</button><button onclick="respondToDouble(false)" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg">RENUNȚ</button></div>`;
                     } else ui.status.innerText = "Așteptare răspuns...";
                } else if (data.lastFlip && !data.actionRequired) {
                     const winnerId = data.lastFlip.result === 'heads' ? data.hostId : data.guestId;
                     if (winnerId === currentUser.uid) showWinnerControls(data);
                }
            }
        }

        window.cancelBet = async () => {
            if (!confirm("Anulezi pariul și recuperezi punctele?")) return;
            const roomRef = doc(db, COLLECTION_ROOMS, currentRoomId);
            const data = (await getDoc(roomRef)).data();
            if (data.status !== 'waiting') return alert("Jocul a început deja!");
            await updateDoc(doc(db, COLLECTION_USERS, currentUser.uid), { balance: increment(data.currentPot) });
            await deleteDoc(roomRef);
            switchView('lobby');
        };

        window.leaveGame = async () => {
            if (!confirm("Ieși din joc? Vei pierde punctele din pot.")) return;
            const roomRef = doc(db, COLLECTION_ROOMS, currentRoomId);
            const data = (await getDoc(roomRef)).data();
            const opponentId = data.hostId === currentUser.uid ? data.guestId : data.hostId;
            if (opponentId) {
                await updateDoc(doc(db, COLLECTION_USERS, opponentId), { balance: increment(data.currentPot), wins: increment(1) });
                await updateDoc(roomRef, { status: 'finished', endReason: 'left', winnerId: opponentId });
            }
            switchView('lobby');
        };

        window.performFlip = async () => {
            const result = Math.random() < 0.5 ? 'heads' : 'tails';
            await updateDoc(doc(db, COLLECTION_ROOMS, currentRoomId), { lastFlip: { result, timestamp: Date.now() } });
        };

        function showWinnerControls(roomData) {
            document.getElementById('my-actions').innerHTML = `<div class="flex flex-col gap-2"><button onclick="proposeDouble()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg border-b-4 border-purple-800">DOUBLE UP (${roomData.currentPot * 2}p)</button><button onclick="takeWinnings()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg border-b-4 border-green-800">CASH OUT ${roomData.currentPot}p</button></div>`;
        }

        window.proposeDouble = async () => {
             const roomRef = doc(db, COLLECTION_ROOMS, currentRoomId);
             const pot = (await getDoc(roomRef)).data().currentPot;
             await updateDoc(roomRef, { actionRequired: 'accept_double', betSize: pot });
        };
        
        window.takeWinnings = async () => {
             const roomRef = doc(db, COLLECTION_ROOMS, currentRoomId);
             const pot = (await getDoc(roomRef)).data().currentPot;
             await updateDoc(doc(db, COLLECTION_USERS, currentUser.uid), { balance: increment(pot), wins: increment(1) });
             await updateDoc(roomRef, { status: 'finished', endReason: 'cashout', winnerId: currentUser.uid }); 
             switchView('lobby');
        };

        window.respondToDouble = async (accepted) => {
            const roomRef = doc(db, COLLECTION_ROOMS, currentRoomId);
            const data = (await getDoc(roomRef)).data();
            if (!accepted) {
                const prevWinnerId = data.lastFlip.result === 'heads' ? data.hostId : data.guestId;
                await updateDoc(doc(db, COLLECTION_USERS, prevWinnerId), { balance: increment(data.currentPot), wins: increment(1) });
                await updateDoc(roomRef, { status: 'finished', endReason: 'folded', winnerId: prevWinnerId });
                switchView('lobby');
            } else {
                if (userData.balance < data.betSize) return alert("Puncte insuficiente!");
                await updateDoc(doc(db, COLLECTION_USERS, currentUser.uid), { balance: increment(-data.betSize) });
                await updateDoc(roomRef, { currentPot: increment(data.betSize), actionRequired: null, lastFlip: null });
            }
        };

        function animateFlip(result) {
            const coin = document.getElementById('coin');
            coin.style.animation = 'none';
            coin.offsetHeight;
            coin.style.animation = result === 'heads' ? "flipHeads 2s forwards" : "flipTails 2s forwards";
        }

        function resetGameUI() {
             document.getElementById('coin').style.animation = 'none';
             document.getElementById('my-actions').innerHTML = '';
             ui.potDisplay.innerText = '0';
             ui.waitingControls.classList.add('hidden');
             ui.activeControls.classList.add('hidden');
        }

        async function loadLeaderboard() {
            ui.leaderboardList.innerHTML = '<div class="text-center p-4">Se încarcă...</div>';
            const q = query(collection(db, COLLECTION_USERS), orderBy("wins", "desc"), limit(10));
            const snap = await getDocs(q);
            let html = '';
            let rank = 1;
            snap.forEach(doc => {
                const d = doc.data();
                html += `<div class="flex justify-between items-center bg-gray-800 p-3 rounded mb-2 border border-gray-700"><div class="flex items-center gap-3"><span class="text-yellow-500 font-bold">#${rank++}</span><span class="font-bold">${d.username}</span></div><div class="text-green-400 font-mono">${d.wins} W</div></div>`;
            });
            ui.leaderboardList.innerHTML = html || '<div class="text-center text-gray-500">Niciun jucător.</div>';
        }

        // Inițializare (Nu auto-login, așteptăm acțiunea utilizatorului)
        // Dacă există user persistent, onAuthStateChanged va rula oricum.
        
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Righteous&family=Roboto:wght@400;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: white; }
        .title-font { font-family: 'Righteous', cursive; }
        .coin-container { perspective: 1000px; width: 120px; height: 120px; margin: 0 auto; }
        .coin { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.5s; }
        .coin-face { position: absolute; width: 100%; height: 100%; border-radius: 50%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border: 4px solid #d4af37; box-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .heads { background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b); transform: rotateY(0deg); }
        .tails { background: radial-gradient(circle at 30% 30%, #c0c0c0, #808080); transform: rotateY(180deg); }
        @keyframes flipHeads { 0% { transform: rotateY(0); } 100% { transform: rotateY(1800deg); } }
        @keyframes flipTails { 0% { transform: rotateY(0); } 100% { transform: rotateY(1980deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-2 cursor-pointer" onclick="switchView('lobby')">
            <i class="fa-solid fa-coins text-yellow-500 text-2xl"></i>
            <span class="title-font text-xl tracking-wider hidden sm:block">COINFLIP PVP</span>
        </div>
        <div class="flex gap-4">
            <button onclick="switchView('lobby')" class="hover:text-yellow-400"><i class="fa-solid fa-gamepad"></i> Lobby</button>
            <button onclick="switchView('leaderboard')" class="hover:text-yellow-400"><i class="fa-solid fa-trophy"></i> Top</button>
            <button onclick="performLogout()" class="hover:text-red-400"><i class="fa-solid fa-sign-out-alt"></i></button>
        </div>
        <div class="bg-gray-800 px-3 py-1 rounded-full flex items-center gap-2 border border-gray-700">
            <i class="fa-solid fa-wallet text-green-400"></i>
            <span class="font-mono font-bold ui-balance">...</span><span class="text-xs ml-1 text-green-400">p</span>
        </div>
    </nav>

    <main class="flex-1 relative overflow-y-auto">

        <!-- Login Screen -->
        <div id="view-login" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900 z-50">
            <div class="text-center mb-8">
                <i class="fa-solid fa-coins text-yellow-500 text-6xl mb-4 animate-bounce"></i>
                <h1 class="text-4xl font-bold title-font text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">COINFLIP PVP</h1>
                <p class="text-gray-400 mt-2">Dublaj sau Nimic cu jucători reali</p>
            </div>
            
            <div class="bg-gray-800 p-8 rounded-2xl border border-gray-700 w-full max-w-md space-y-4">
                <button onclick="loginGoogle()" class="w-full bg-white hover:bg-gray-100 text-gray-900 font-bold py-3 rounded-xl flex items-center justify-center transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3">
                    Conectare cu Google
                </button>
                
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-500 text-sm">SAU</span>
                    <div class="flex-grow border-t border-gray-600"></div>
                </div>

                <button onclick="loginGuest()" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition">
                    <i class="fa-solid fa-user-secret mr-2"></i> Joacă ca Oaspete
                </button>
            </div>
        </div>

        <!-- Lobby -->
        <div id="view-lobby" class="p-6 max-w-2xl mx-auto hidden">
            
            <!-- Profil & Bonus -->
            <div class="bg-gray-800 p-4 rounded-xl mb-8 border border-gray-700 flex flex-col sm:flex-row gap-4 justify-between items-center">
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <img src="" class="ui-avatar w-12 h-12 rounded-full border-2 border-yellow-500">
                    <div>
                        <div class="text-xs text-gray-500">BINE AI VENIT</div>
                        <div class="font-bold text-lg ui-username">Jucător</div>
                    </div>
                </div>
                
                <!-- Card Bonus Zilnic -->
                <div id="bonus-card" class="bg-gray-900/50 p-3 rounded-lg border border-gray-600 text-center w-full sm:w-auto min-w-[200px]">
                    <div class="text-xs text-yellow-500 font-bold mb-1 uppercase tracking-wider">BONUS ZILNIC</div>
                    <button id="btn-claim-bonus" onclick="claimDailyBonus()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold py-1 px-4 rounded w-full transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Așteaptă...
                    </button>
                    <div id="bonus-timer" class="text-[10px] text-gray-400 mt-1 font-mono">Verificare...</div>
                </div>
            </div>

            <!-- Meciuri Active -->
            <div class="mb-8">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-2">Pariurile Mele</h3>
                <div id="active-games-list" class="space-y-2"></div>
            </div>

            <!-- Cod Privat -->
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 mb-8">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-3">Intră cu Cod</h3>
                <div class="flex gap-2">
                    <input type="text" id="join-room-code" placeholder="Cod Cameră" class="bg-gray-900 text-white px-4 py-2 rounded-lg flex-1 border border-gray-600 focus:border-yellow-500 outline-none">
                    <button onclick="joinByCode()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold">INTRĂ</button>
                </div>
            </div>

            <!-- Meci Rapid -->
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4">Meci Rapid (Public)</h3>
            <div class="grid grid-cols-4 gap-2 mb-8">
                <button onclick="findMatch(10)" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-yellow-500 p-4 rounded-xl font-bold">10p</button>
                <button onclick="findMatch(50)" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-yellow-500 p-4 rounded-xl font-bold">50p</button>
                <button onclick="findMatch(100)" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-yellow-500 p-4 rounded-xl font-bold">100p</button>
                <button onclick="findMatch(500)" class="bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-yellow-500 p-4 rounded-xl font-bold">500p</button>
            </div>

            <!-- Creează Cameră -->
            <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-4">Creează Cameră Privată</h3>
                <div class="flex gap-2 mb-2">
                    <input type="number" id="custom-bet-size" placeholder="Suma (p)" class="bg-gray-800 text-white px-4 py-2 rounded-lg w-1/3 border border-gray-700 outline-none">
                    <input type="text" id="custom-room-code" placeholder="Cod Secret (Opțional)" class="bg-gray-800 text-white px-4 py-2 rounded-lg flex-1 border border-gray-700 outline-none">
                </div>
                <button onclick="createPrivateRoom()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold">CREEAZĂ</button>
            </div>
        </div>

        <!-- Ecran Joc -->
        <div id="view-game" class="h-full flex flex-col hidden relative">
            <div class="bg-gray-800 p-4 flex justify-between items-center shadow-lg z-10">
                <div class="flex items-center gap-3">
                    <img src="" class="ui-avatar w-10 h-10 rounded-full border border-gray-600">
                    <div><div class="text-sm font-bold ui-username">Eu</div><div class="text-xs text-green-400"><span class="ui-balance">0</span>p</div></div>
                </div>
                <div class="text-center"><div class="text-xs text-gray-500 uppercase">Pot</div><div class="text-2xl font-bold text-yellow-400"><span id="pot-display">0</span>p</div></div>
                <div class="flex items-center gap-3 text-right"><div><div class="text-sm font-bold" id="opponent-name">Așteptare...</div><div class="text-xs text-gray-400" id="opponent-status">...</div></div><div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center font-bold"><i class="fa-solid fa-user"></i></div></div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-b from-gray-900 to-black relative">
                <div id="game-status" class="text-xl mb-8 font-bold text-center h-16">Se încarcă...</div>
                
                <div id="waiting-controls" class="absolute top-24 hidden">
                    <button onclick="cancelBet()" class="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-700 px-4 py-1 rounded text-sm"><i class="fa-solid fa-xmark mr-1"></i> Anulează & Refund</button>
                </div>
                <div id="active-controls" class="absolute top-24 hidden">
                    <button onclick="leaveGame()" class="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-700 px-4 py-1 rounded text-sm"><i class="fa-solid fa-person-running mr-1"></i> Ieși din joc</button>
                </div>

                <div class="coin-container mb-12">
                    <div class="coin" id="coin">
                        <div class="coin-face heads"><i class="fa-solid fa-crown text-4xl text-white"></i></div>
                        <div class="coin-face tails"><i class="fa-solid fa-skull text-4xl text-white"></i></div>
                    </div>
                </div>
                <div id="game-actions" class="w-full max-w-md"><div id="my-actions" class="flex flex-col gap-2"></div></div>
            </div>
        </div>

        <div id="view-leaderboard" class="p-6 max-w-2xl mx-auto hidden">
            <h2 class="text-2xl font-bold mb-6 text-yellow-500"><i class="fa-solid fa-crown mr-2"></i>Clasament Global</h2>
            <div id="leaderboard-list"></div>
        </div>

    </main>
</body>
</html>